<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Order Page</title>
</head>

<body>
  <h2>Order Page</h2>
  <div id="orderList"></div>
  <script type="module" src="/api/order.js"></script>
</body>

</html>
<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesan Makanan - QuickOrder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      min-height: 100vh;
    }

    .menu-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .menu-card:hover {
      transform: translateY(-5px);
    }

    .queue-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff6b6b, #ffa500);
      color: white;
      padding: 15px 25px;
      border-radius: 50px;
      font-size: 1.2rem;
      font-weight: bold;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    .cart-summary {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      position: sticky;
      top: 20px;
    }
  </style>
</head>

<body>
  <div class="queue-badge" id="queueBadge">
    <i class="fas fa-clock me-2"></i>Antrian: <span id="queueNumber">-</span>
  </div>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-utensils me-2"></i>QuickOrder
      </a>
      <div class="ms-auto">
        <span class="navbar-text me-3" id="userWelcome">Selamat datang!</span>
        <button class="btn btn-outline-light" onclick="logout()">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </button>
      </div>
    </div>
  </nav>

  <div class="container my-5">
    <div class="row">
      <div class="col-lg-8">
        <h2 class="text-white mb-4">Menu Makanan</h2>
        <div class="row" id="menuContainer">
          <!-- Menu items akan dimuat di sini -->
        </div>
      </div>
      <div class="col-lg-4">
        <div class="cart-summary">
          <h4 class="mb-3">Keranjang Belanja</h4>
          <div id="cartItems">
            <p class="text-muted">Keranjang kosong</p>
          </div>
          <hr>
          <div class="d-flex justify-content-between">
            <strong>Total: Rp <span id="totalPrice">0</span></strong>
          </div>
          <button class="btn btn-success w-100 mt-3" id="orderBtn" onclick="placeOrder()" disabled>
            <i class="fas fa-shopping-cart me-2"></i>Pesan Sekarang
          </button>
        </div>

        <div class="mt-4">
          <a href="live-chat.html" class="btn btn-info w-100">
            <i class="fas fa-comments me-2"></i>Chat dengan Admin
          </a>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBVzfZU-Kc4LyNC_6mOAzisn2jU1HRmqcM",
      authDomain: "order-proj.firebaseapp.com",
      projectId: "order-proj",
      storageBucket: "order-proj.firebasestorage.app",
      messagingSenderId: "235438844119",
      appId: "1:235438844119:web:48c6c5fc53da46bbc26892",
      measurementId: "G-ES8YZMS72L"
    };


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let cart = [];
    let currentUser = null;

    // Sample menu data
    const menuItems = [
      {
        id: 1,
        name: "Nasi Goreng Spesial",
        price: 25000,
        image: "https://via.placeholder.com/300x200",
        description: "Nasi goreng dengan telur, ayam, dan sayuran segar"
      },
      {
        id: 2,
        name: "Mie Ayam Bakso",
        price: 20000,
        image: "https://via.placeholder.com/300x200",
        description: "Mie ayam dengan bakso dan pangsit goreng"
      },
      {
        id: 3,
        name: "Gado-gado",
        price: 18000,
        image: "https://via.placeholder.com/300x200",
        description: "Sayuran segar dengan bumbu kacang khas"
      },
      {
        id: 4,
        name: "Ayam Bakar",
        price: 30000,
        image: "https://via.placeholder.com/300x200",
        description: "Ayam bakar bumbu kecap dengan lalapan"
      }
    ];

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('userWelcome').textContent = `Halo, ${user.displayName || user.email}!`;
        loadMenu();
        loadQueue();
      } else {
        window.location.href = 'user.html';
      }
    });

    function loadMenu() {
      const container = document.getElementById('menuContainer');
      container.innerHTML = '';

      menuItems.forEach(item => {
        const menuCard = `
                    <div class="col-md-6 mb-4">
                        <div class="menu-card">
                            <img src="${item.image}" class="card-img-top" alt="${item.name}" style="height: 200px; object-fit: cover;">
                            <div class="card-body">
                                <h5 class="card-title">${item.name}</h5>
                                <p class="card-text text-muted">${item.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="h5 text-success">Rp ${item.price.toLocaleString()}</span>
                                    <button class="btn btn-primary" onclick="addToCart(${item.id})">
                                        <i class="fas fa-plus me-1"></i>Tambah
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        container.innerHTML += menuCard;
      });
    }

    window.addToCart = function (itemId) {
      const item = menuItems.find(m => m.id === itemId);
      const existingItem = cart.find(c => c.id === itemId);

      if (existingItem) {
        existingItem.quantity++;
      } else {
        cart.push({ ...item, quantity: 1 });
      }

      updateCartDisplay();
    };

    function updateCartDisplay() {
      const cartContainer = document.getElementById('cartItems');
      const totalPriceElement = document.getElementById('totalPrice');
      const orderBtn = document.getElementById('orderBtn');

      if (cart.length === 0) {
        cartContainer.innerHTML = '<p class="text-muted">Keranjang kosong</p>';
        totalPriceElement.textContent = '0';
        orderBtn.disabled = true;
        return;
      }

      let cartHTML = '';
      let total = 0;

      cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        cartHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <small>${item.name}</small><br>
                            <small class="text-muted">${item.quantity} x Rp ${item.price.toLocaleString()}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                `;
      });

      cartContainer.innerHTML = cartHTML;
      totalPriceElement.textContent = total.toLocaleString();
      orderBtn.disabled = false;
    }

    window.removeFromCart = function (itemId) {
      const itemIndex = cart.findIndex(c => c.id === itemId);
      if (itemIndex > -1) {
        if (cart[itemIndex].quantity > 1) {
          cart[itemIndex].quantity--;
        } else {
          cart.splice(itemIndex, 1);
        }
      }
      updateCartDisplay();
    };

    window.placeOrder = async function () {
      if (cart.length === 0) return;

      try {
        const orderData = {
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          items: cart,
          total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
          status: 'pending',
          orderTime: new Date(),
          queueNumber: await getNextQueueNumber()
        };

        await addDoc(collection(db, 'orders'), orderData);

        alert(`Pesanan berhasil! Nomor antrian Anda: ${orderData.queueNumber}`);
        cart = [];
        updateCartDisplay();
        loadQueue();
      } catch (error) {
        alert('Error membuat pesanan: ' + error.message);
      }
    };

    async function getNextQueueNumber() {
      // Simulasi nomor antrian - dalam implementasi nyata, ini harus atomic
      const today = new Date().toDateString();
      return Math.floor(Math.random() * 100) + 1;
    }

    function loadQueue() {
      if (!currentUser) return;

      const q = query(
        collection(db, 'orders'),
        where('userId', '==', currentUser.uid),
        orderBy('orderTime', 'desc')
      );

      onSnapshot(q, (snapshot) => {
        const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const pendingOrder = orders.find(order => order.status === 'pending');

        if (pendingOrder) {
          document.getElementById('queueNumber').textContent = pendingOrder.queueNumber;
        } else {
          document.getElementById('queueNumber').textContent = '-';
        }
      });
    }

    window.logout = async function () {
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        alert('Error logout: ' + error.message);
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>